<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head th:replace="fragments/layout :: head('ì¼ì • ê´€ë¦¬')">
</head>

<body>
<!-- ì™¼ìª½ ë©”ë‰´ -->
<div th:replace="fragments/layout :: sidebar('schedule')"></div>

<!-- ì»¨í…ì¸  ì˜ì—­ -->
<div class="content-wrapper">
    <div class="container-fluid">
        <div class="row">
            <!-- ë‹¬ë ¥ ì˜ì—­ -->
            <div class="col-lg-8">
                <div class="calendar-container">
                    <div class="month-header">
                        <span id="current-month"></span>
                        <div class="float-end">
                            <button id="prev-month" class="btn btn-sm btn-outline-secondary me-2">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <button id="next-month" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <table class="calendar">
                        <thead>
                        <tr>
                            <th>ì¼</th>
                            <th>ì›”</th>
                            <th>í™”</th>
                            <th>ìˆ˜</th>
                            <th>ëª©</th>
                            <th>ê¸ˆ</th>
                            <th>í† </th>
                        </tr>
                        </thead>
                        <tbody id="calendar-body">
                        <!-- ë‹¬ë ¥ ë‚´ìš©ì€ JavaScriptë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ì‹œê°„ëŒ€ ì˜ì—­ -->
            <div class="col-lg-4">
                <div class="schedule-panel">
                    <div class="date-header" id="selected-date-header">
                        ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”
                    </div>
                    <div id="time-slots-container">
                        <div class="text-center text-muted my-5">
                            <i class="bi bi-calendar-date fs-1"></i>
                            <p class="mt-3">ì™¼ìª½ ë‹¬ë ¥ì—ì„œ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                        </div>
                    </div>
                    <button class="schedule-btn" id="set-schedule-btn" style="display: none;">ìŠ¤ì¼€ì¤„ ì„¤ì •</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ëª¨ë°”ì¼ Bottom Navigation -->
<div th:replace="fragments/layout :: bottomnav('schedule')"></div>

<!-- ìŠ¤ì¼€ì¤„ ì„¤ì • ëª¨ë‹¬ -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scheduleModalLabel">ìƒë‹´ ê°€ëŠ¥ ì‹œê°„ ì„¤ì •</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>ìƒë‹´ ê°€ëŠ¥í•œ ì‹œê°„ëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                <div id="time-options-container" class="d-flex flex-wrap">
                    <!-- ì‹œê°„ ì˜µì…˜ë“¤ì€ JavaScriptë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn save-btn" id="save-schedule-btn">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<!-- ìƒë‹´ ìƒì„± ëª¨ë‹¬ -->
<div class="modal fade" id="consultationModal" tabindex="-1" aria-labelledby="consultationModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="consultationModalLabel">ìƒë‹´ ìƒì„±</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>í•™ìƒ ì´ë¦„ì„ ê²€ìƒ‰í•˜ì—¬ ìƒë‹´ì„ ìƒì„±í•˜ì„¸ìš”.</p>
                <div class="position-relative mb-3">
                    <input type="text" class="search-input" id="student-search" placeholder="í•™ìƒ ì´ë¦„ ê²€ìƒ‰...">
                </div>
                <div id="search-results" class="mt-3">
                    <!-- ê²€ìƒ‰ ê²°ê³¼ëŠ” JavaScriptë¡œ í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn create-consultation-btn" id="create-consultation-btn">ìƒë‹´ ìƒì„±</button>
            </div>
        </div>
    </div>
</div>

<!-- ì˜ˆì •ëœ ìƒë‹´ ì·¨ì†Œ ëª¨ë‹¬ -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelModalLabel">ì˜ˆì•½ëœ ìƒë‹´</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="cancelDayTime">5ì›” 30ì¼ 10:00 - 11:00</p>
                <p id="cancelNameGroup">ë°±ì—”ë“œ / í™©ì±„ì—°</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn create-consultation-btn" id="cancel-consultation-btn">ì˜ˆì•½ ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    // Thymeleafê°€ slotsë¥¼ JavaScriptë¡œ ë³€í™˜í•˜ì—¬ í• ë‹¹í•©ë‹ˆë‹¤.
    const allSlots = [[${slots}]];
    const allStudents = [[${students}]];
    console.log(allStudents);
</script>


<th:block th:replace="fragments/layout :: scripts"></th:block>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let today = new Date(); // ì˜¤ëŠ˜ ë‚ ì§œ
        today.setHours(0, 0, 0, 0);

        let currentDate = new Date(today); // í˜„ì¬ ë³´ì—¬ì§€ëŠ” ë‹¬ë ¥ ë‚ ì§œ
        let selectedDate = null;
        let selectedTimeSlot = null;

        // ìº˜ë¦°ë” ì´ˆê¸°í™”
        initCalendar();


        // ì´ì „/ë‹¤ìŒ ì›” ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('prev-month').addEventListener('click', function () {
            let prevMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
            if (prevMonth >= new Date(today.getFullYear(), today.getMonth(), 1)) {
                currentDate = prevMonth;
                updateCalendar();
            }
        });

        document.getElementById('next-month').addEventListener('click', function () {
            let nextMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
            let maxMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1); // ë‹¤ìŒ ë‹¬ê¹Œì§€ë§Œ í—ˆìš©
            if (nextMonth <= maxMonth) {
                currentDate = nextMonth;
                updateCalendar();
            }
        });

        // ìŠ¤ì¼€ì¤„ ì„¤ì • ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('set-schedule-btn').addEventListener('click', function () {
            const dataString = this.dataset.data; // datasetì—ì„œ ë¬¸ìì—´ í˜•íƒœë¡œ ì½ìŒ
            const scheduleSlotSelect = JSON.parse(dataString); // ë¬¸ìì—´ì„ ë°°ì—´ë¡œ ë³€í™˜

            openScheduleModal(scheduleSlotSelect);
        });


        // ìŠ¤ì¼€ì¤„ ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('save-schedule-btn').addEventListener('click', function () {
            saveSchedule();
        });

        // ìº˜ë¦°ë” ì´ˆê¸°í™” í•¨ìˆ˜
        function initCalendar() {
            updateCalendar();
        }

        // ìº˜ë¦°ë” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay(); // 0-6 (ì¼-í† )

            // ì›” í—¤ë” ì—…ë°ì´íŠ¸
            document.getElementById('current-month').textContent = `${year}ë…„ ${month + 1}ì›”`;

            // ìº˜ë¦°ë” ë°”ë”” ì´ˆê¸°í™”
            const calendarBody = document.getElementById('calendar-body');
            calendarBody.innerHTML = '';

            let date = 1;
            for (let i = 0; i < 6; i++) {
                // í•„ìš”í•œ ê²½ìš°ì—ë§Œ í–‰ ì¶”ê°€
                if (date > daysInMonth) break;

                const row = document.createElement('tr');

                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');

                    if (i === 0 && j < startingDay) {
                        // ì´ì „ ë‹¬ ë‚ ì§œ
                        cell.classList.add('text-muted');
                        cell.classList.add('disabled'); // í´ë¦­ ë§‰ê¸°ìš© CSS í´ë˜ìŠ¤
                    } else if (date > daysInMonth) {
                        // ë‹¤ìŒ ë‹¬ ë‚ ì§œ
                        cell.classList.add('text-muted');
                        cell.classList.add('disabled'); // í´ë¦­ ë§‰ê¸°ìš© CSS í´ë˜ìŠ¤
                    } else {
                        // í˜„ì¬ ë‹¬ ë‚ ì§œ
                        cell.innerHTML = `<div class="date-number">${date}</div>`;

                        const cellDate = new Date(year, month, date);

                        // ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ
                        //const today = new Date();
                        if (cellDate.getDate() === today.getDate() &&
                            cellDate.getMonth() === today.getMonth() &&
                            cellDate.getFullYear() === today.getFullYear()) {
                            cell.classList.add('today');
                        }

                        if (j === 0 || j === 6) {
                            cell.classList.add('disabled');
                            cell.classList.add('text-muted');
                        } else {
                            // ë‚ ì§œ ì„ íƒ ì´ë²¤íŠ¸
                            cell.addEventListener('click', function () {
                                const allCells = document.querySelectorAll('.calendar td');
                                allCells.forEach(c => c.classList.remove('selected'));

                                this.classList.add('selected');
                                selectedDate = cellDate;

                                console.log('selectedDate:', selectedDate);
                                updateTimeSlotsPanel();
                            });
                        }

                        date++;
                    }

                    row.appendChild(cell);
                }

                calendarBody.appendChild(row);
            }
        }

        // ì‹œê°„ëŒ€ íŒ¨ë„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateTimeSlotsPanel() {
            if (!selectedDate) return;

            // ë‚ ì§œ í¬ë§· (YYYYë…„ MMì›” DDì¼ (ìš”ì¼))
            const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const formattedDate = `${selectedDate.getFullYear()}ë…„ ${selectedDate.getMonth() + 1}ì›” ${selectedDate.getDate()}ì¼ (${weekdays[selectedDate.getDay()]})`;
            document.getElementById('selected-date-header').textContent = formattedDate;

            // ì‹œê°„ëŒ€ í‘œì‹œ (ì„ì‹œ ë°ì´í„°)
            const timeSlotsContainer = document.getElementById('time-slots-container');
            timeSlotsContainer.innerHTML = '';

            const scheduleSlotSelect = [0, 0, 0, 0, 0, 0, 0, 0];

            // allSlotsì—ì„œ selectedDateì— ë§ëŠ” ì‹œê°„ëŒ€ë§Œ í•„í„°ë§
            allSlots.filter(slot => {
                const slotDate = new Date(slot.startTime); // startTimeì„ Date ê°ì²´ë¡œ ë³€í™˜
                return slotDate.toDateString() === selectedDate.toDateString(); // ë‚ ì§œë§Œ ë¹„êµ
            }).forEach(slot => {
                const consultDate = `${selectedDate.getMonth() + 1}ì›” ${selectedDate.getDate()}ì¼`;
                const startEndTime = slot.startTime.slice(11, 16) +' - '+ slot.endTime.slice(11, 16);
                const studentNameGroup = slot.studentName + '/' + slot.studentClassGroup;

                const timeSlot = document.createElement('div');
                timeSlot.classList.add('time-slot');

                // ì‹œì‘ ì‹œê°„ìœ¼ë¡œ ë°°ì—´ ì¸ë±ìŠ¤ ê²°ì •
                const startHour = parseInt(slot.startTime.slice(11, 13)); // ì˜ˆ: 09, 10 ë“±
                const index = startHour - 9; // 09ì‹œë¶€í„° ì‹œì‘ì´ë¯€ë¡œ 9ë¥¼ ë¹¼ì„œ ì¸ë±ìŠ¤(0~7)ë¡œ

                if (slot.status === 'ì‚¬ìš©ê°€ëŠ¥') {
                    scheduleSlotSelect[index] = 1;
                    timeSlot.classList.add('available');
                    timeSlot.innerHTML = `<div>${startEndTime}</div>`;
                    timeSlot.addEventListener('click', function () {
                        openConsultationModal(slot.id, slot.startTime, consultDate, startEndTime);
                    });
                } else if (slot.status === 'ë¶ˆê°€ëŠ¥') {
                    scheduleSlotSelect[index] = 2;
                    timeSlot.classList.add('booked');
                    timeSlot.innerHTML = `<div>${startEndTime}</div><div class="student-name">${studentNameGroup}</div>`;
                    timeSlot.addEventListener('click', function () {
                        openCancelModal(consultDate, startEndTime, slot.consultingId, studentNameGroup);
                    });
                } else {
                    // ë¹„í™œì„±í™” (ì§€ë‚˜ê°”ì§€ë§Œ ì˜ˆì•½ì´ ì—†ì—ˆë˜ íƒ€ì„)
                    timeSlot.innerHTML = `<div>${startEndTime}</div>`;
                }


                timeSlotsContainer.appendChild(timeSlot);
            });
            // ìŠ¤ì¼€ì¤„ ì„¤ì • ë²„íŠ¼ í‘œì‹œ
            const setSchedule = document.getElementById('set-schedule-btn');
            setSchedule.style.display = 'block';
            setSchedule.dataset.data = JSON.stringify(scheduleSlotSelect);
        }

        // ìŠ¤ì¼€ì¤„ ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
        function openScheduleModal(scheduleSlotSelect) {
            if (!selectedDate) return;

            console.log(scheduleSlotSelect);
            // ì‹œê°„ ì˜µì…˜ ìƒì„±
            const timeOptionsContainer = document.getElementById('time-options-container');
            timeOptionsContainer.innerHTML = '';

            // ì‹œê°„ ì˜µì…˜ (9ì‹œ~17ì‹œê¹Œì§€ 1ì‹œê°„ ë‹¨ìœ„)
            const timeOptions = [
                '09:00 - 10:00', '10:00 - 11:00', '11:00 - 12:00', '12:00 - 13:00',
                '13:00 - 14:00', '14:00 - 15:00', '15:00 - 16:00', '16:00 - 17:00'
            ];

            timeOptions.forEach(((time, index) => {
                const option = document.createElement('div');
                option.classList.add('time-option');
                option.textContent = time;

                const status = scheduleSlotSelect[index];

                // ğŸ‘‰ scheduleSlotSelect ê°’ì´ 1ì´ë©´ ë¯¸ë¦¬ ì„ íƒ
                if (status === 1) {
                    option.classList.add('selected');
                }else if (status === 2) {
                    // ë¶ˆê°€ëŠ¥ â†’ ë¹„í™œì„±í™”
                    option.classList.add('disabled');
                    option.style.pointerEvents = 'none';
                    option.style.opacity = '0.4'; // íë¦¬ê²Œ í‘œì‹œ
                }

                option.addEventListener('click', function () {
                    this.classList.toggle('selected');
                });

                timeOptionsContainer.appendChild(option);
            }));

            // ëª¨ë‹¬ ì—´ê¸°
            const scheduleModal = new bootstrap.Modal(document.getElementById('scheduleModal'));
            scheduleModal.show();
        }

        // ìŠ¤ì¼€ì¤„ ì €ì¥ í•¨ìˆ˜
        function saveSchedule() {
            // Array.from(document.querySelectorAll('.time-option.selected'))
            //     .map(el => el.textContent);

            const timeOptions = document.querySelectorAll('.time-option');
            // ì‚¬ìš©ìì˜ ì„ íƒì— ì˜í•´ ë°”ë€ ì¸ë±ìŠ¤ ì €ì¥í•˜ëŠ” ë°°ì—´ (ë¹„í™œì„± ìŠ¬ë¡¯ í¬í•¨)
            const updatedScheduleSlotSelect = Array.from(timeOptions).map(option =>
                option.classList.contains('selected') ? 1 : 0
            );

            // ì´ì „ ì¸ë±ìŠ¤ ìƒíƒœ ì €ì¥í•˜ëŠ” ë°°ì—´
            const prevScheduleSlotSelect = JSON.parse(document.getElementById('set-schedule-btn').dataset.data);

            // ì‚¬ìš©ìì˜ ì„ íƒì— ì˜í•´ ë°”ë€ ì¸ë±ìŠ¤ ì €ì¥í•˜ëŠ” ë°°ì—´
            const changedIndices = updatedScheduleSlotSelect
                .map((val, i) => {
                    // ì²˜ìŒ ìƒíƒœê°€ 0 ë˜ëŠ” 1ì¼ ë•Œë§Œ ë¹„êµ
                    if (prevScheduleSlotSelect[i] === 0 || prevScheduleSlotSelect[i] === 1) {
                        return val !== prevScheduleSlotSelect[i] ? i : -1;
                    }
                    return -1; // 2 ì¸ë±ìŠ¤ëŠ” ë¬´ì‹œ
                })
                .filter(i => i !== -1);

            // ìƒì„±, ì‚­ì œ ë¶„ë¦¬
            const slotsToCreate = [];
            const slotsToDelete = [];

            changedIndices.forEach(i => {
                if (prevScheduleSlotSelect[i] === 0 && updatedScheduleSlotSelect[i] === 1) {
                    slotsToCreate.push(i); // ìƒì„±
                } else if (prevScheduleSlotSelect[i] === 1 && updatedScheduleSlotSelect[i] === 0) {
                    slotsToDelete.push(i); // ì‚­ì œ
                }
            });

            // ì„œë²„ì— í•˜ë‚˜ì˜ í¼ìœ¼ë¡œ ì „ì†¡
            submitScheduleChanges(slotsToCreate, slotsToDelete);

            // ì €ì¥ í›„ ëª¨ë‹¬ ë‹«ê¸°
            const scheduleModal = bootstrap.Modal.getInstance(document.getElementById('scheduleModal'));
            scheduleModal.hide();

            // ì €ì¥ í›„ ì‹œê°„ëŒ€ íŒ¨ë„ ì—…ë°ì´íŠ¸
            updateTimeSlotsPanel();

            // ì„±ê³µ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
            alert('ìŠ¤ì¼€ì¤„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function submitScheduleChanges(slotsToCreate, slotsToDelete) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/teacher/schedule/update';

            // ìƒì„±í•  ìŠ¬ë¡¯ ì‹œê°„ë“¤
            const createInput = document.createElement('input');
            createInput.type = 'hidden';
            createInput.name = 'createSlots';
            const createSlotsValue = JSON.stringify(slotsToCreate.map(getSlotDateTime));
            createInput.value = createSlotsValue;
            console.log('ìƒì„±í•  ìŠ¬ë¡¯ ì‹œê°„ë“¤:', createSlotsValue); // ìƒì„±ë  ì‹œê°„ ì¶œë ¥
            form.appendChild(createInput);

            // ì‚­ì œí•  ìŠ¬ë¡¯ IDë“¤
            const deleteInput = document.createElement('input');
            deleteInput.type = 'hidden';
            deleteInput.name = 'deleteSlotIds';
            const deleteSlotIdsValue = JSON.stringify(
                slotsToDelete.map(index => {
                    const slot = allSlots.find(slot => {
                        const slotDate = new Date(slot.startTime);
                        return (
                            slotDate.toDateString() === selectedDate.toDateString() &&
                            slotDate.getHours() === 9 + index
                        );
                    });
                    return slot ? slot.id : null;
                }).filter(Boolean)
            );
            deleteInput.value = deleteSlotIdsValue;
            console.log('ì‚­ì œí•  ìŠ¬ë¡¯ IDë“¤:', deleteSlotIdsValue); // ì‚­ì œë  ID ì¶œë ¥

            form.appendChild(deleteInput);

            // csrf
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_csrf';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);

            document.body.appendChild(form);
            form.submit();
        }


        function getSlotDateTime(index) {
            const baseDate = new Date(selectedDate);
            baseDate.setHours(9 + index, 0, 0, 0);
            // í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜ (UTC +9)
            const kstOffset = 9 * 60; // UTC+9
            baseDate.setMinutes(baseDate.getMinutes() + kstOffset);

            // KST ê¸°ì¤€ ì‹œê°„ ë°˜í™˜ (ISO ë¬¸ìì—´ë¡œ ë³€í™˜)
            return baseDate.toISOString(); // ì˜ˆ: "2025-05-01T16:00:00.000+09:00"
        }


        // ìƒë‹´ ìƒì„± ëª¨ë‹¬ ì—´ê¸°
        function openConsultationModal(slotId, date, consultDate, startEndTime) {

            // í•™ìƒ ê²€ìƒ‰ ì…ë ¥ ì´ˆê¸°í™”
            document.getElementById('student-search').value = '';
            document.getElementById('search-results').innerHTML = '';
            document.getElementById('consultationModalLabel').innerHTML = `${consultDate} ${startEndTime}`;

            // ëª¨ë‹¬ ì—´ê¸°
            const consultationModal = new bootstrap.Modal(document.getElementById('consultationModal'));
            consultationModal.show();

            // í•™ìƒ ê²€ìƒ‰ ì´ë²¤íŠ¸
            document.getElementById('student-search').addEventListener('input', function () {
                const searchTerm = this.value.trim();

                if (searchTerm.length < 2) {
                    document.getElementById('search-results').innerHTML = '';
                    return;
                }

                // í•™ìƒ ê²€ìƒ‰
                const mockResults = allStudents.filter(student => student.name.includes(searchTerm));

                const searchResults = document.getElementById('search-results');
                searchResults.innerHTML = '';

                if (mockResults.length === 0) {
                    searchResults.innerHTML = '<p class="text-center text-muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    const resultsList = document.createElement('ul');
                    resultsList.classList.add('list-group');

                    mockResults.forEach(student => {
                        const item = document.createElement('li');
                        item.classList.add('list-group-item', 'list-group-item-action');
                        item.dataset.id = student.userId;
                        item.innerHTML = `<strong>${student.name}</strong> (${student.classGroupName})`;

                        item.addEventListener('click', function () {
                            // ì„ íƒëœ í•™ìƒ í‘œì‹œ
                            const allItems = document.querySelectorAll('.list-group-item');
                            allItems.forEach(i => i.classList.remove('active'));
                            this.classList.add('active');
                        });

                        resultsList.appendChild(item);
                    });

                    searchResults.appendChild(resultsList);
                }
            });

            // ìƒë‹´ ìƒì„± ë²„íŠ¼ ì´ë²¤íŠ¸
            document.getElementById('create-consultation-btn').addEventListener('click', function () {
                const selectedStudent = document.querySelector('.list-group-item.active');

                if (!selectedStudent) {
                    alert('í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                const selectedStudentId = selectedStudent.dataset.id;

                // ìƒë‹´ ìƒì„± ë¡œì§ (ì„œë²„ì— ìš”ì²­)
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/teacher/consulting/reservation`;

                // hidden input - studentId
                const studentInput = document.createElement('input');
                studentInput.type = 'hidden';
                studentInput.name = 'studentId';
                studentInput.value = selectedStudentId;
                form.appendChild(studentInput);

                // hidden input - timeInput
                const timeInput = document.createElement('input');
                timeInput.type = 'hidden';
                timeInput.name = 'startTime';
                timeInput.value = date;
                form.appendChild(timeInput);

                // hidden input - slotId
                const selectSlotId = document.createElement('input');
                selectSlotId.type = 'hidden';
                selectSlotId.name = 'slotId';
                selectSlotId.value = slotId;
                form.appendChild(selectSlotId);

                // csrf
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '_csrf';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);

                document.body.appendChild(form);
                form.submit();


                // ëª¨ë‹¬ ë‹«ê¸°
                const consultationModal = bootstrap.Modal.getInstance(document.getElementById('consultationModal'));
                consultationModal.hide();

                // ì‹œê°„ëŒ€ íŒ¨ë„ ì—…ë°ì´íŠ¸
                updateTimeSlotsPanel();

                // ì„±ê³µ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
                alert('ìƒë‹´ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
            });
        }

        // ìƒë‹´ ì·¨ì†Œ ëª¨ë‹¬ ì—´ê¸°
        function openCancelModal(consultDate, startEndTime, consultingId, studentNameGroup) {

            // ëª¨ë‹¬ ì—´ê¸°
            const cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));
            document.getElementById('cancelDayTime').innerHTML = `${consultDate} ${startEndTime}`;
            document.getElementById('cancelNameGroup').innerHTML = `${studentNameGroup}`;
            cancelModal.show();


            // ìƒë‹´ ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸
            document.getElementById('cancel-consultation-btn').addEventListener('click', function () {
                if (!confirm('ìƒë‹´ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/teacher/consulting/${consultingId}/cancel`;
                document.body.appendChild(form);

                // csrf
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '_csrf';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
                form.submit();

                // ëª¨ë‹¬ ë‹«ê¸°
                const consultationModal = bootstrap.Modal.getInstance(document.getElementById('cancelModal'));
                consultationModal.hide();

                // ì‹œê°„ëŒ€ íŒ¨ë„ ì—…ë°ì´íŠ¸
                updateTimeSlotsPanel();

                // ì„±ê³µ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
                alert('ìƒë‹´ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            });
        }
    });
</script>
</body>
</html>