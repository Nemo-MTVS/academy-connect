<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head th:replace="fragments/layout :: head('일정 관리')">
</head>

<body>
    <!-- 왼쪽 메뉴 -->
    <div th:replace="fragments/layout :: sidebar('schedule')"></div>
    
    <!-- 컨텐츠 영역 -->
    <div class="content-wrapper">
        <div class="container-fluid">
            <div class="row">
                <!-- 달력 영역 -->
                <div class="col-lg-8">
                    <div class="calendar-container">
                        <div class="month-header">
                            <span id="current-month"></span>
                            <div class="float-end">
                                <button id="prev-month" class="btn btn-sm btn-outline-secondary me-2">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                                <button id="next-month" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        <table class="calendar">
                            <thead>
                                <tr>
                                    <th>일</th>
                                    <th>월</th>
                                    <th>화</th>
                                    <th>수</th>
                                    <th>목</th>
                                    <th>금</th>
                                    <th>토</th>
                                </tr>
                            </thead>
                            <tbody id="calendar-body">
                                <!-- 달력 내용은 JavaScript로 생성됩니다 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 시간대 영역 -->
                <div class="col-lg-4">
                    <div class="schedule-panel">
                        <div class="date-header" id="selected-date-header">
                            날짜를 선택하세요
                        </div>
                        <div id="time-slots-container">
                            <div class="text-center text-muted my-5">
                                <i class="bi bi-calendar-date fs-1"></i>
                                <p class="mt-3">왼쪽 달력에서 날짜를 선택하세요</p>
                            </div>
                        </div>
                        <button class="schedule-btn" id="set-schedule-btn" style="display: none;">스케줄 설정</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 모바일 Bottom Navigation -->
    <div th:replace="fragments/layout :: bottomnav('schedule')"></div>
    
    <!-- 스케줄 설정 모달 -->
    <div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scheduleModalLabel">상담 가능 시간 설정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>상담 가능한 시간대를 선택하세요.</p>
                    <div id="time-options-container" class="d-flex flex-wrap">
                        <!-- 시간 옵션들은 JavaScript로 생성됩니다 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn save-btn" id="save-schedule-btn">저장</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 상담 생성 모달 -->
    <div class="modal fade" id="consultationModal" tabindex="-1" aria-labelledby="consultationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="consultationModalLabel">상담 생성</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>학생 이름을 검색하여 상담을 생성하세요.</p>
                    <div class="position-relative mb-3">
                        <input type="text" class="search-input" id="student-search" placeholder="학생 이름 검색...">
                    </div>
                    <div id="search-results" class="mt-3">
                        <!-- 검색 결과는 JavaScript로 표시됩니다 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn create-consultation-btn" id="create-consultation-btn">상담 생성</button>
                </div>
            </div>
        </div>
    </div>
    
    <th:block th:replace="fragments/layout :: scripts"></th:block>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 현재 날짜 정보
            let currentDate = new Date();
            let selectedDate = null;
            let selectedTimeSlot = null;
            
            // 캘린더 초기화
            initCalendar();
            
            // 이전/다음 월 버튼 이벤트
            document.getElementById('prev-month').addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateCalendar();
            });
            
            document.getElementById('next-month').addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateCalendar();
            });
            
            // 스케줄 설정 버튼 이벤트
            document.getElementById('set-schedule-btn').addEventListener('click', function() {
                openScheduleModal();
            });
            
            // 스케줄 저장 버튼 이벤트
            document.getElementById('save-schedule-btn').addEventListener('click', function() {
                saveSchedule();
            });
            
            // 캘린더 초기화 함수
            function initCalendar() {
                updateCalendar();
            }
            
            // 캘린더 업데이트 함수
            function updateCalendar() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDay = firstDay.getDay(); // 0-6 (일-토)
                
                // 월 헤더 업데이트
                document.getElementById('current-month').textContent = `${year}년 ${month + 1}월`;
                
                // 캘린더 바디 초기화
                const calendarBody = document.getElementById('calendar-body');
                calendarBody.innerHTML = '';
                
                let date = 1;
                for (let i = 0; i < 6; i++) {
                    // 필요한 경우에만 행 추가
                    if (date > daysInMonth) break;
                    
                    const row = document.createElement('tr');
                    
                    for (let j = 0; j < 7; j++) {
                        const cell = document.createElement('td');
                        
                        if (i === 0 && j < startingDay) {
                            // 이전 달 날짜
                            cell.classList.add('text-muted');
                        } else if (date > daysInMonth) {
                            // 다음 달 날짜
                            cell.classList.add('text-muted');
                        } else {
                            // 현재 달 날짜
                            cell.innerHTML = `<div class="date-number">${date}</div>`;
                            
                            const cellDate = new Date(year, month, date);
                            
                            // 오늘 날짜 표시
                            const today = new Date();
                            if (cellDate.getDate() === today.getDate() && 
                                cellDate.getMonth() === today.getMonth() && 
                                cellDate.getFullYear() === today.getFullYear()) {
                                cell.classList.add('today');
                            }
                            
                            // 날짜 선택 이벤트
                            cell.addEventListener('click', function() {
                                const allCells = document.querySelectorAll('.calendar td');
                                allCells.forEach(c => c.classList.remove('selected'));
                                
                                this.classList.add('selected');
                                selectedDate = new Date(year, month, date);
                                
                                updateTimeSlotsPanel();
                            });
                            
                            date++;
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    calendarBody.appendChild(row);
                }
            }
            
            // 시간대 패널 업데이트 함수
            function updateTimeSlotsPanel() {
                if (!selectedDate) return;
                
                // 날짜 포맷 (YYYY년 MM월 DD일 (요일))
                const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
                const formattedDate = `${selectedDate.getFullYear()}년 ${selectedDate.getMonth() + 1}월 ${selectedDate.getDate()}일 (${weekdays[selectedDate.getDay()]})`;
                document.getElementById('selected-date-header').textContent = formattedDate;
                
                // 시간대 표시 (임시 데이터)
                const timeSlotsContainer = document.getElementById('time-slots-container');
                timeSlotsContainer.innerHTML = '';
                
                // 스케줄 설정 버튼 표시
                document.getElementById('set-schedule-btn').style.display = 'block';
                
                // 임시 데이터 (실제 데이터는 서버에서 가져와야 함)
                const mockTimeSlots = [
                    { time: '09:00 - 10:00', status: 'unavailable' },
                    { time: '10:00 - 11:00', status: 'available' },
                    { time: '11:00 - 12:00', status: 'booked', student: '학생1' },
                    { time: '13:00 - 14:00', status: 'available' },
                    { time: '14:00 - 15:00', status: 'unavailable' },
                    { time: '15:00 - 16:00', status: 'booked', student: '학생2' },
                    { time: '16:00 - 17:00', status: 'available' }
                ];
                
                mockTimeSlots.forEach(slot => {
                    const timeSlot = document.createElement('div');
                    timeSlot.classList.add('time-slot');
                    
                    if (slot.status === 'available') {
                        timeSlot.classList.add('available');
                        timeSlot.innerHTML = `<div>${slot.time}</div>`;
                        timeSlot.addEventListener('click', function() {
                            openConsultationModal(slot.time);
                        });
                    } else if (slot.status === 'booked') {
                        timeSlot.classList.add('booked');
                        timeSlot.innerHTML = `
                            <div>${slot.time}</div>
                            <div class="student-name">${slot.student}</div>
                        `;
                    } else {
                        timeSlot.innerHTML = `<div>${slot.time}</div>`;
                    }
                    
                    timeSlotsContainer.appendChild(timeSlot);
                });
            }
            
            // 스케줄 설정 모달 열기
            function openScheduleModal() {
                if (!selectedDate) return;
                
                // 시간 옵션 생성
                const timeOptionsContainer = document.getElementById('time-options-container');
                timeOptionsContainer.innerHTML = '';
                
                // 임시 시간 옵션 (9시~17시까지 1시간 단위)
                const timeOptions = [
                    '09:00 - 10:00', '10:00 - 11:00', '11:00 - 12:00', '12:00 - 13:00',
                    '13:00 - 14:00', '14:00 - 15:00', '15:00 - 16:00', '16:00 - 17:00'
                ];
                
                timeOptions.forEach(time => {
                    const option = document.createElement('div');
                    option.classList.add('time-option');
                    option.textContent = time;
                    
                    option.addEventListener('click', function() {
                        this.classList.toggle('selected');
                    });
                    
                    timeOptionsContainer.appendChild(option);
                });
                
                // 모달 열기
                const scheduleModal = new bootstrap.Modal(document.getElementById('scheduleModal'));
                scheduleModal.show();
            }
            
            // 스케줄 저장 함수
            function saveSchedule() {
                // 선택된 시간대 저장 로직
                const selectedTimes = Array.from(document.querySelectorAll('.time-option.selected'))
                    .map(el => el.textContent);
                
                // 저장 후 모달 닫기
                const scheduleModal = bootstrap.Modal.getInstance(document.getElementById('scheduleModal'));
                scheduleModal.hide();
                
                // 저장 후 시간대 패널 업데이트
                updateTimeSlotsPanel();
                
                // 성공 알림 (선택사항)
                alert('스케줄이 저장되었습니다.');
            }
            
            // 상담 생성 모달 열기
            function openConsultationModal(timeSlot) {
                selectedTimeSlot = timeSlot;
                
                // 학생 검색 입력 초기화
                document.getElementById('student-search').value = '';
                document.getElementById('search-results').innerHTML = '';
                
                // 모달 열기
                const consultationModal = new bootstrap.Modal(document.getElementById('consultationModal'));
                consultationModal.show();
                
                // 학생 검색 이벤트
                document.getElementById('student-search').addEventListener('input', function() {
                    const searchTerm = this.value.trim();
                    
                    if (searchTerm.length < 2) {
                        document.getElementById('search-results').innerHTML = '';
                        return;
                    }
                    
                    // 임시 검색 결과 (실제로는 서버에 요청해야 함)
                    const mockResults = [
                        { id: 1, name: '김학생', grade: '3학년' },
                        { id: 2, name: '이학생', grade: '2학년' },
                        { id: 3, name: '박학생', grade: '1학년' }
                    ].filter(student => student.name.includes(searchTerm));
                    
                    const searchResults = document.getElementById('search-results');
                    searchResults.innerHTML = '';
                    
                    if (mockResults.length === 0) {
                        searchResults.innerHTML = '<p class="text-center text-muted">검색 결과가 없습니다.</p>';
                    } else {
                        const resultsList = document.createElement('ul');
                        resultsList.classList.add('list-group');
                        
                        mockResults.forEach(student => {
                            const item = document.createElement('li');
                            item.classList.add('list-group-item', 'list-group-item-action');
                            item.innerHTML = `<strong>${student.name}</strong> (${student.grade})`;
                            
                            item.addEventListener('click', function() {
                                // 선택된 학생 표시
                                const allItems = document.querySelectorAll('.list-group-item');
                                allItems.forEach(i => i.classList.remove('active'));
                                this.classList.add('active');
                            });
                            
                            resultsList.appendChild(item);
                        });
                        
                        searchResults.appendChild(resultsList);
                    }
                });
                
                // 상담 생성 버튼 이벤트
                document.getElementById('create-consultation-btn').addEventListener('click', function() {
                    const selectedStudent = document.querySelector('.list-group-item.active');
                    
                    if (!selectedStudent) {
                        alert('학생을 선택해주세요.');
                        return;
                    }
                    
                    // 상담 생성 로직 (서버에 요청)
                    
                    // 모달 닫기
                    const consultationModal = bootstrap.Modal.getInstance(document.getElementById('consultationModal'));
                    consultationModal.hide();
                    
                    // 시간대 패널 업데이트
                    updateTimeSlotsPanel();
                    
                    // 성공 알림 (선택사항)
                    alert('상담이 생성되었습니다.');
                });
            }
        });
    </script>
</body>
</html>