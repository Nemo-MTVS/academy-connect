<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{instructor-layout :: html(~{::title}, ~{::link}, ~{this::section}, ~{::script})}">

<head>
    <title>전체 예약 보기</title>
    <link th:href="@{/css/bookinglist.css}" rel="stylesheet">
</head>
<body>
<section>
    <div class="container mt-4">
        <!-- 탭 메뉴 -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link" th:classappend="${activeTab == 'upcoming' ? 'active' : ''}" 
                   th:href="@{/instructor/consulting-bookings?view=upcoming}">예정된 예약</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${activeTab == 'past' ? 'active' : ''}" 
                   th:href="@{/instructor/consulting-bookings?view=past}">지난 예약</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${activeTab == 'past' ? 'active' : ''}"
                   th:href="@{/instructor/consulting-bookings?view=past}">예약 요청</a>
            </li>
        </ul>

        <!-- 제목 -->
        <div class="consulting-inner">
            <div class="status-box">
                <span>학생</span>
            </div>
            <div class="status-box">
                <span>날짜</span>
            </div>
            <div class="status-box" >
                <span>시간</span>
            </div>
            <div class="status-box">
                <span>상태</span>
            </div>
            <div class="status-box">
                <span>상담 메시지</span>
            </div>
        </div>


        <div th:if="${bookings != null && !bookings.isEmpty()}" class="row">
                <div class="col-12 mb-3" th:each="booking : ${bookings}">
                <div class="consulting-card">
                    <div class="consulting-inner">
                        <!-- 프로필 & 정보 -->
                        <div class="user-info">
                            <img class="avatar" src="https://placehold.co/29x29" />
                            <div class="user-text">
                                <div class="name" th:text="${booking.studentName}">이름</div>
                                <div class="role" th:text="${booking.classGroup}">반</div>
                            </div>
                        </div>

                        <!-- 날짜 -->
                        <div class="date-box"  th:text="${booking.formattedStartTime}">
                            <span>날짜</span>
                        </div>

                        <!-- 시간 -->
                        <div class="time-box" th:text="${booking.formattedStartTimeOnly}" >
                            <span>시간</span>
                        </div>

                        <!-- 상태 + 취소 버튼 -->
                        <div class="status-box">
                            <span th:class="${booking.statusClass}" th:text="${booking.status}">상태</span>
                            <div th:if="${booking.cancellable}">
                                <form th:action="@{/instructor/consulting/{id}/cancel(id=${booking.id})}" method="post"
                                      onsubmit="return confirm('예약을 취소하시겠습니까?');">
                                    <button type="submit" class="cancel-btn">X</button>
                                </form>
                            </div>

                        </div>

                        <!-- 상담 요청 내용 -->
                        <div class="message-box">
                            <span th:text="${booking.safeMessage}">상담 메시지</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 예약이 없을 경우 -->
        <div th:if="${bookings != null && bookings.isEmpty()}" class="empty-state">
            <div class="text-center py-5">
                <img src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/icons/calendar-x.svg" alt="No bookings" width="64" height="64">
                <h4 class="mt-3" th:text="${activeTab == 'upcoming' ? '예정된 예약이 없습니다.' : '지난 예약이 없습니다.'}">예약 없음</h4>
                <p class="text-muted" th:text="${activeTab == 'upcoming' ? '상담 예약을 통해 학생과 1:1 대화를 나눠보세요!' : '상담 내역이 여기에 기록됩니다.'}">안내 메시지</p>
                <a th:if="${activeTab == 'upcoming'}" th:href="@{/student/consulting-booking}" class="btn btn-primary mt-2">예약하기</a>
            </div>
        </div>
   </div>
</section>

<script>
    // 성공 알림 토스트
    document.addEventListener('DOMContentLoaded', function() {
        var urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('success')) {
            // Bootstrap toast 초기화 및 표시 로직
            var toastEl = document.createElement('div');
            toastEl.className = 'toast align-items-center text-white bg-success border-0 position-fixed bottom-0 end-0 m-3';
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        예약이 성공적으로 취소되었습니다.
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            document.body.appendChild(toastEl);
            
            var toast = new bootstrap.Toast(toastEl, {
                animation: true,
                autohide: true,
                delay: 3000
            });
            toast.show();
        }
    });
</script>
</body>
</html>